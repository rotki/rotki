<template>
  <div>
    <v-row no-gutters>
      <v-checkbox
        :value="enabled"
        :label="$t('premium_credentials.label_enable')"
        @change="updateEnabled"
      />
    </v-row>
    <div v-if="enabled">
      <v-row no-gutters>
        <v-col>
          <v-switch
            label="Restore synced database"
            :value="syncDatabase"
            @change="updateSyncDatabase"
          />
        </v-col>
        <v-col cols="auto">
          <v-tooltip bottom max-width="400px">
            <template #activator="{ on }">
              <v-icon small class="mb-3 ml-1" v-on="on">mdi-information</v-icon>
            </template>
            <span>
              {{ $t('premium_credentials.tooltip') }}
            </span>
          </v-tooltip>
        </v-col>
      </v-row>

      <revealable-input
        outlined
        :value="apiKey"
        :disabled="loading"
        class="premium-settings__fields__api-key"
        :rules="apiKeyRules"
        :label="$t('premium_credentials.label_api_key')"
        @input="updateApiKey"
        @paste="onApiKeyPaste"
      />
      <revealable-input
        outlined
        :value="apiSecret"
        :disabled="loading"
        class="premium-settings__fields__api-secret"
        prepend-icon="mdi-lock"
        :label="$t('premium_credentials.label_api_secret')"
        :rules="apiSecretRules"
        @input="updateApiSecret"
        @paste="onApiSecretPaste"
      />
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, ref, toRefs, watch } from '@vue/composition-api';
import { IVueI18n } from 'vue-i18n';
import RevealableInput from '@/components/inputs/RevealableInput.vue';
import i18n from '@/i18n';
import { trimOnPaste } from '@/utils/event';

const setupValidationRules = (i18n: IVueI18n) => {
  const apiKeyRules = [
    (v: string) =>
      !!v || i18n.t('premium_credentials.validation.non_empty_key').toString()
  ];
  const apiSecretRules = [
    (v: string) =>
      !!v ||
      i18n.t('premium_credentials.validation.non_empty_secret').toString()
  ];
  return { apiKeyRules, apiSecretRules };
};

const PremiumCredentials = defineComponent({
  name: 'PremiumCredentials',
  components: { RevealableInput },
  props: {
    loading: { required: true, type: Boolean },
    enabled: { required: true, type: Boolean },
    apiSecret: { required: true, type: String },
    apiKey: { required: true, type: String },
    syncDatabase: { required: true, type: Boolean }
  },
  emits: [
    'update:api-key',
    'update:api-secret',
    'update:enabled',
    'update:sync-database'
  ],
  setup(props, { emit }) {
    const { enabled } = toRefs(props);
    const showKey = ref(false);
    const showSecret = ref(false);

    const updateApiKey = (apiKey: string) => {
      emit('update:api-key', apiKey?.trim() ?? '');
    };

    const updateApiSecret = (apiSecret: string) => {
      emit('update:api-secret', apiSecret?.trim() ?? '');
    };

    const updateEnabled = (enabled: boolean | null) => {
      emit('update:enabled', !!enabled);
    };

    const updateSyncDatabase = (enabled: boolean | null) => {
      emit('update:sync-database', !!enabled);
    };

    const onApiKeyPaste = (_event: ClipboardEvent) => {
      const paste = trimOnPaste(_event);
      if (paste) {
        updateApiKey(paste);
      }
    };

    const onApiSecretPaste = (_event: ClipboardEvent) => {
      const paste = trimOnPaste(_event);
      if (paste) {
        updateApiSecret(paste);
      }
    };

    watch(enabled, enabled => {
      if (enabled) {
        return;
      }
      updateApiKey('');
      updateApiSecret('');
    });

    return {
      updateApiKey,
      updateApiSecret,
      updateEnabled,
      updateSyncDatabase,
      onApiKeyPaste,
      onApiSecretPaste,
      showKey,
      showSecret,
      ...setupValidationRules(i18n)
    };
  }
});
export default PremiumCredentials;
</script>
