<script setup lang="ts">
const visibilityStore = useAreaVisibilityStore();
const { showDrawer, isMini } = storeToRefs(visibilityStore);
const { overall } = storeToRefs(useStatisticsStore());
const { logged } = storeToRefs(useSessionAuthStore());
const toggleDrawer = visibilityStore.toggleDrawer;

const { isXlAndDown } = useBreakpoint();
const { updateTray } = useInterop();
const { shouldShowScrollToTopButton, scrollToTop } = useCoreScroll();

const expanded = logicAnd(showDrawer, logicNot(isXlAndDown));

watch(overall, (overall) => {
  if (overall.percentage === '-')
    return;

  updateTray(overall);
});

onBeforeMount(() => {
  initGraph();
});

onMounted(() => {
  set(showDrawer, !get(isXlAndDown));
});
</script>

<template>
  <div class="app__content">
    <NotificationPopup />
    <AppDrawer />

    <header
      class="app__app-bar fixed top-0 left-0 w-full bg-white dark:bg-[#1E1E1E] md:h-16 h-[3.5rem] border-b border-rui-grey-300 dark:border-rui-grey-800"
    >
      <nav class="flex items-center md:h-16 h-[3.5rem] px-2">
        <RuiButton
          icon
          variant="text"
          class="!text-rui-text-secondary"
          @click="toggleDrawer()"
        >
          <RuiIcon name="menu-line" />
        </RuiButton>
        <AppIndicators />
      </nav>
    </header>

    <AppSidebars />
    <div
      class="app-main"
      :class="{
        small: isMini,
        expanded,
      }"
    >
      <main>
        <RouterView #default="{ Component }">
          <Transition
            enter-from-class="opacity-0"
            enter-to-class="opacity-1"
            enter-active-class="transition duration-300"
            leave-from-class="opacity-1"
            leave-to-class="opacity-0"
            leave-active-class="transition duration-100"
          >
            <div
              v-if="!logged"
              class="fixed top-0 left-0 w-full h-full bg-white z-[999] flex items-center justify-center"
            >
              <RuiProgress
                thickness="2"
                color="primary"
                variant="indeterminate"
                circular
              />
            </div>
            <component
              :is="Component"
              v-else
            />
          </Transition>
        </RouterView>
      </main>

      <Transition
        enter-from-class="opacity-0"
        enter-to-class="opacity-1"
        enter-active-class="transition duration-300"
        leave-from-class="opacity-1"
        leave-to-class="opacity-0"
        leave-active-class="transition duration-100"
      >
        <RuiButton
          v-if="shouldShowScrollToTopButton"
          color="primary"
          class="fixed bottom-4 right-4 z-[6]"
          variant="fab"
          icon
          @click="scrollToTop()"
        >
          <RuiIcon name="arrow-up-line" />
        </RuiButton>
      </Transition>
    </div>
  </div>
</template>

<style scoped lang="scss">
.app {
  &-main {
    @apply pt-6 pb-16 w-full;
    min-height: calc(100vh - 64px);

    &.small {
      @apply pl-[3.5rem];
    }

    &.expanded {
      @apply pl-[300px];
    }
  }
}
</style>
